<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journal Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Patrick+Hand&display=swap');
        .font-hand { fontFamily: 'Patrick Hand', cursive; }
        .font-mono { fontFamily: 'Courier Prime', monospace; }
        
        /* Modal Backdrop */
        #login-modal {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden relative">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl border border-gray-100 max-w-md w-full text-center">
            <div class="mb-6">
                <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="lock" class="w-8 h-8 text-orange-500"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Admin Access</h2>
                <p class="text-gray-500 mt-2 text-sm">Please authenticate to manage the journal.</p>
            </div>
            
            <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-gray-900 hover:bg-black text-white py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] shadow-lg">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                <span class="font-medium">Sign in with Google</span>
            </button>
            <p id="auth-error" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <!-- Header / Config -->
    <header class="bg-white border-b border-gray-200 p-4 shadow-sm z-10 flex-none blur-sm transition-all duration-300" id="main-header">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2 justify-between w-full md:w-auto">
                <div class="flex items-center gap-2">
                    <i data-lucide="book-open" class="text-orange-500"></i>
                    <h1 class="font-bold text-xl tracking-tight">Journal<span class="text-orange-500">Manager</span></h1>
                </div>
                <!-- User email visible on mobile inside header row -->
                <span id="user-display" class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 md:hidden"></span>
            </div>
            
            <span id="user-display-desktop" class="hidden md:inline-block ml-4 text-xs bg-gray-100 px-2 py-1 rounded text-gray-500"></span>

            <div class="flex flex-wrap gap-2 text-sm w-full md:w-auto items-center justify-end">
                <!-- Hardcoded Repo Info Display -->
                <div class="hidden md:flex flex-col items-end mr-2 text-xs text-gray-400">
                    <span id="disp-repo">Repo: ...</span>
                    <span id="disp-user">User: ...</span>
                </div>

                <button onclick="loadFromGitHub()" class="bg-gray-800 text-white px-4 py-1 rounded hover:bg-black transition flex items-center gap-2 whitespace-nowrap flex-grow md:flex-grow-0 justify-center">
                    <i data-lucide="download-cloud" class="w-3 h-3"></i> <span id="load-btn-text">Load</span>
                </button>
                
                <button onclick="logout()" class="ml-2 text-gray-400 hover:text-red-500 p-1" title="Sign Out">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <!-- Changed to flex-col on mobile, flex-row on desktop for responsive layout -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden blur-sm transition-all duration-300" id="main-content">
        
        <!-- Sidebar: Entry List -->
        <!-- w-full on mobile with fixed height, w-64 on desktop with full height -->
        <aside class="w-full md:w-64 h-48 md:h-auto bg-white border-b md:border-b-0 md:border-r border-gray-200 overflow-y-auto flex-none flex flex-col shadow-sm md:shadow-none z-10">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 sticky top-0 z-10">
                <h2 class="font-semibold text-sm uppercase text-gray-500">Entries</h2>
                <button onclick="createNewEntry()" class="p-1 hover:bg-gray-200 rounded text-green-600" title="New Entry">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="entry-list" class="flex-1">
                <div class="p-8 text-center text-gray-400 text-sm">
                    Waiting for data...
                </div>
            </div>
        </aside>

        <!-- Editor Area -->
        <main class="flex-1 bg-gray-50 p-4 md:p-8 overflow-y-auto relative">
            
            <div id="editor-container" class="max-w-3xl mx-auto bg-white rounded-lg shadow-sm border border-gray-200 hidden pb-20 md:pb-0">
                <!-- Toolbar -->
                <div class="border-b border-gray-100 p-4 flex justify-between items-center bg-gray-50/50 rounded-t-lg sticky top-0 z-10 backdrop-blur-md bg-opacity-90">
                    <span class="text-xs font-mono text-gray-400" id="editing-id">ID: -</span>
                    <div class="flex gap-2">
                        <button onclick="deleteEntry()" class="text-red-500 hover:text-red-700 text-sm px-3 py-1 flex items-center gap-1 border border-red-100 rounded hover:bg-red-50">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> <span class="hidden sm:inline">Delete</span>
                        </button>
                        <button onclick="saveChanges()" class="bg-orange-500 text-white hover:bg-orange-600 px-4 py-1 rounded text-sm font-medium shadow-sm flex items-center gap-1">
                            <i data-lucide="save" class="w-3 h-3"></i> <span class="hidden sm:inline">Publish</span>
                        </button>
                    </div>
                </div>

                <!-- Form -->
                <div class="p-4 md:p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
                            <input type="text" id="edit-title" class="w-full border border-gray-300 rounded px-3 py-2 font-serif text-lg focus:ring-2 focus:ring-orange-200 focus:border-orange-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Date (YYYY-MM-DD)</label>
                            <input type="date" id="edit-date" class="w-full border border-gray-300 rounded px-3 py-2 focus:ring-2 focus:ring-orange-200 outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mood</label>
                            <select id="edit-mood" class="w-full border border-gray-300 rounded px-3 py-2 bg-white text-sm">
                                <option>Excited</option>
                                <option>Calm</option>
                                <option>Frustrated</option>
                                <option>Determined</option>
                                <option>Focused</option>
                                <option>Happy</option>
                                <option>Tired</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Weather</label>
                            <select id="edit-weather" class="w-full border border-gray-300 rounded px-3 py-2 bg-white text-sm">
                                <option>Sunny</option>
                                <option>Rainy</option>
                                <option>Cloudy</option>
                                <option>Cold</option>
                                <option>Snowy</option>
                                <option>Windy</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tags</label>
                            <input type="text" id="edit-tags" class="w-full border border-gray-300 rounded px-3 py-2 text-sm placeholder-gray-300" placeholder="Coding, Travel...">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label>
                        <input type="text" id="edit-image" class="w-full border border-gray-300 rounded px-3 py-2 text-sm font-mono text-gray-600">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Summary</label>
                        <input type="text" id="edit-summary" class="w-full border border-gray-300 rounded px-3 py-2 text-sm font-hand text-lg text-gray-600">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Content</label>
                        <textarea id="edit-content" rows="12" class="w-full border border-gray-300 rounded px-3 py-2 font-serif leading-relaxed focus:ring-2 focus:ring-orange-200 outline-none text-gray-700"></textarea>
                    </div>
                </div>
            </div>

            <!-- Initial Empty State -->
            <div id="initial-state" class="h-full flex flex-col items-center justify-center text-gray-400">
                <i data-lucide="github" class="w-12 h-12 mb-4 opacity-20"></i>
                <p>Authenticated. Click <span class="font-bold text-gray-600">Load</span> to fetch journal.</p>
            </div>

        </main>
    </div>

    <!-- Notifications -->
    <div id="notification" class="fixed bottom-4 right-4 left-4 md:left-auto bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-40 transition-transform duration-300 flex items-center gap-3 z-50 max-w-md mx-auto md:mx-0">
        <i data-lucide="info" class="w-5 h-5 flex-shrink-0"></i>
        <span id="notification-msg" class="text-sm truncate">Message</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from './firebase-config.js';

        // --- HARDCODED CONFIG ---
        // REPLACE THESE WITH YOUR ACTUAL GITHUB DETAILS
        const GH_USERNAME = "smashcoder"; 
        const GH_REPO = "blog"; 
        const FILE_PATH = "blogData.js"; // File must be in root of repo

        // --- FIREBASE SETUP ---
        //const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let currentData = [];
        let currentSha = "";
        let selectedId = null;
        let githubToken = "";

        // Display Constants
        document.getElementById('disp-repo').textContent = `Repo: ${GH_REPO}`;
        document.getElementById('disp-user').textContent = `User: ${GH_USERNAME}`;

        // --- AUTH FLOW ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            }
            // We do NOT fetch anonymously here because user requested explicit popup login
        };
        initAuth();

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const modal = document.getElementById('login-modal');
            const mainHeader = document.getElementById('main-header');
            const mainContent = document.getElementById('main-content');

            if (user) {
                // Logged In
                modal.classList.add('hidden');
                mainHeader.classList.remove('blur-sm');
                mainContent.classList.remove('blur-sm');
                
                // Update both displays (mobile and desktop)
                document.getElementById('user-display').textContent = user.email;
                document.getElementById('user-display-desktop').textContent = user.email;
                
                // Attempt to auto-fetch token from DB
                await fetchSavedToken(user.uid);
            } else {
                // Logged Out
                modal.classList.remove('hidden');
                mainHeader.classList.add('blur-sm');
                mainContent.classList.add('blur-sm');
                document.getElementById('entry-list').innerHTML = '<div class="p-8 text-center text-gray-400 text-sm">Waiting for login...</div>';
            }
        });

        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
                document.getElementById('auth-error').classList.remove('hidden');
            }
        };

        window.logout = () => signOut(auth);

        // --- TOKEN MANAGEMENT ---
        async function fetchSavedToken(userId) {
            try {
                const tokenRef = doc(db, 'artifacts', appId, 'users', userId, 'config', 'github');
                const docSnap = await getDoc(tokenRef);
                
                if (docSnap.exists() && docSnap.data().token) {
                    githubToken = docSnap.data().token;
                    showNotification("GitHub authentication confirmed.");
                    // Auto load data
                    loadFromGitHub();
                } else {
                    showNotification("Something went wrong. (Token not found in system)");
                }
            } catch (e) {
                console.error("Error fetching token:", e);
                showNotification("Something went wrong.");
            }
        }

        // --- GITHUB API ---
        window.loadFromGitHub = async () => {
            if(!githubToken) {
                showNotification("Something went wrong. (Authentication missing)");
                return;
            }

            const url = `https://api.github.com/repos/${GH_USERNAME}/${GH_REPO}/contents/${FILE_PATH}`;
            
            showNotification("Fetching data...", true);
            document.getElementById('load-btn-text').textContent = "Loading...";

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if(!response.ok) throw new Error("Failed to fetch. Check permissions.");

                const data = await response.json();
                currentSha = data.sha;
                
                // Content parsing
                const content = decodeURIComponent(escape(atob(data.content)));
                
                try {
                    // Try Strict JSON
                    const firstBracket = content.indexOf('[');
                    const lastBracket = content.lastIndexOf(']');
                    
                    if (firstBracket !== -1 && lastBracket !== -1) {
                        const jsonCandidate = content.substring(firstBracket, lastBracket + 1);
                        currentData = JSON.parse(jsonCandidate);
                    } else {
                        // Try Eval fallback
                        const getContent = new Function(content + "\nreturn blogData;");
                        currentData = getContent();
                    }
                } catch(e) {
                    throw new Error("Could not parse blogData.js.");
                }

                renderList();
                document.getElementById('initial-state').classList.add('hidden');
                document.getElementById('load-btn-text').textContent = "Refresh";
                showNotification("Data loaded!");

            } catch (err) {
                console.error(err);
                showNotification("Something went wrong.");
                document.getElementById('load-btn-text').textContent = "Load";
            }
        };

        window.saveChanges = async () => {
            if(!currentSha) {
                showNotification("No data loaded. Cannot save.");
                return;
            }
            
            if(!githubToken) {
                showNotification("Something went wrong. (Authentication lost)");
                return;
            }
            
            updateCurrentEntryFromForm();

            const url = `https://api.github.com/repos/${GH_USERNAME}/${GH_REPO}/contents/${FILE_PATH}`;

            const newContentString = `// This file contains all the diary entries.
// You can edit this file to add, remove, or change blog posts.

const blogData = ${JSON.stringify(currentData, null, 4)};`;
            
            const contentBase64 = btoa(unescape(encodeURIComponent(newContentString)));

            const payload = {
                message: "Update blogData via Admin Panel",
                content: contentBase64,
                sha: currentSha
            };

            showNotification("Publishing to GitHub...", true);

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if(!response.ok) {
                    const errorDetails = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(`GitHub: ${errorDetails.message || 'Unknown Error'}`);
                }

                const result = await response.json();
                currentSha = result.content.sha; 
                
                showNotification("Published successfully!");
                
            } catch (err) {
                console.error(err);
                let friendlyMsg = err.message;
                if (friendlyMsg.includes("Resource not accessible by personal access token")) {
                    friendlyMsg = "Error: Token permissions issue. Check settings.";
                }
                showNotification(friendlyMsg, true);
            }
        };

        // --- CRUD UI ---
        
        window.createNewEntry = () => {
            if (!currentData) return;
            const newId = currentData.length > 0 ? Math.max(...currentData.map(e => e.id)) + 1 : 1;
            const today = new Date().toISOString().split('T')[0];
            
            const newEntry = {
                id: newId,
                date: today,
                title: "New Entry",
                summary: "Summary...",
                content: "<p>Content...</p>",
                mood: "Calm",
                weather: "Sunny",
                tags: ["Journal"],
                image: ""
            };
            
            currentData.push(newEntry);
            selectEntry(newId);
        };

        window.deleteEntry = async () => {
            if (selectedId === null) return;
            if(!confirm("Delete this entry? This will publish changes immediately.")) return;

            currentData = currentData.filter(e => e.id !== selectedId);
            selectedId = null;
            document.getElementById('editor-container').classList.add('hidden');
            renderList();
            
            await window.saveChanges();
        };

        function selectEntry(id) {
            if (selectedId !== null) updateCurrentEntryFromForm();
            selectedId = id;
            const entry = currentData.find(e => e.id === id);
            if (!entry) return;

            document.getElementById('editing-id').textContent = `ID: ${entry.id}`;
            document.getElementById('edit-title').value = entry.title || "";
            document.getElementById('edit-date').value = entry.date || "";
            document.getElementById('edit-mood').value = entry.mood || "Calm";
            document.getElementById('edit-weather').value = entry.weather || "Sunny";
            document.getElementById('edit-tags').value = (entry.tags || []).join(', ');
            document.getElementById('edit-image').value = entry.image || "";
            document.getElementById('edit-summary').value = entry.summary || "";
            document.getElementById('edit-content').value = entry.content || "";

            document.getElementById('editor-container').classList.remove('hidden');
            renderList();
        }

        function renderList() {
            const list = document.getElementById('entry-list');
            list.innerHTML = '';
            const sorted = [...currentData].sort((a,b) => b.id - a.id);

            sorted.forEach(entry => {
                const item = document.createElement('div');
                item.className = `p-4 border-b border-gray-100 cursor-pointer hover:bg-orange-50 transition ${entry.id === selectedId ? 'bg-orange-50 border-orange-200' : ''}`;
                item.onclick = () => selectEntry(entry.id);
                item.innerHTML = `
                    <h3 class="font-bold text-sm text-gray-800 truncate">${entry.title}</h3>
                    <div class="flex justify-between items-center mt-1">
                        <span class="text-xs text-gray-400 font-mono">${entry.date}</span>
                        <span class="text-[10px] bg-gray-200 px-2 rounded-full text-gray-600">${entry.mood}</span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function updateCurrentEntryFromForm() {
            if (selectedId === null) return;
            const entryIndex = currentData.findIndex(e => e.id === selectedId);
            if (entryIndex === -1) return;

            const tagsStr = document.getElementById('edit-tags').value;
            const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t.length > 0);

            currentData[entryIndex] = {
                ...currentData[entryIndex],
                title: document.getElementById('edit-title').value,
                date: document.getElementById('edit-date').value,
                mood: document.getElementById('edit-mood').value,
                weather: document.getElementById('edit-weather').value,
                image: document.getElementById('edit-image').value,
                summary: document.getElementById('edit-summary').value,
                content: document.getElementById('edit-content').value,
                tags: tags
            };
        }

        let notificationTimeout;
        window.showNotification = function(msg, persist = false) {
            const el = document.getElementById('notification');
            document.getElementById('notification-msg').textContent = msg;
            el.classList.remove('translate-y-40');
            clearTimeout(notificationTimeout);
            if (!persist) {
                notificationTimeout = setTimeout(() => {
                    el.classList.add('translate-y-40');
                }, 5000);
            }
        };

        // Icons
        lucide.createIcons();
        
        // Listeners
        document.getElementById('edit-title').addEventListener('input', () => {
            updateCurrentEntryFromForm();
            renderList(); 
        });

    </script>
</body>
</html>